<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS LUT Generator f√ºr Farbfilterung</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        h1 {
            color: #e0e0e0;
            text-align: center;
        }
        .upload-section, .color-section, .preview-section, .generate-section {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background-color: #252525;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ccc;
        }
        button {
            background-color: #e65c00;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #ff6600;
        }
        .button-icon {
            background-color: #444;
            color: white;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-left: 5px;
        }
        .button-icon:hover {
            background-color: #555;
        }
        .color-picker {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .preview-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .preview-item {
            flex: 1;
            min-width: 300px;
        }
        canvas {
            border: 1px solid #444;
            max-width: 100%;
            height: auto;
            background-color: #111;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container input {
            width: 100%;
            background-color: #333;
        }
        .range-display {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 12px;
            color: #aaa;
        }
        .color-display {
            width: 50px;
            height: 50px;
            border: 1px solid #444;
        }
        input[type="color"] {
            background-color: #333;
            border: none;
            height: 30px;
        }
        input[type="file"] {
            color: #ccc;
            background-color: #333;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .eyedropper-active {
            cursor: crosshair;
        }
        .color-container {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #2a2a2a;
        }
        .color-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .color-controls {
            display: flex;
            align-items: center;
        }
        h3 {
            color: #ddd;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>OBS LUT Generator f√ºr Farbfilterung</h1>

        <div class="upload-section">
            <label for="imageUpload">Spielscreenshot hochladen:</label>
            <input type="file" id="imageUpload" accept="image/*">
        </div>

        <div class="color-section">
            <h3>Farbeinstellungen</h3>
            <div id="colorsContainer">
                <!-- Farben werden hier dynamisch hinzugef√ºgt -->
            </div>
            
            <button id="addColorBtn">Farbe hinzuf√ºgen</button>
            
            <div class="slider-container">
                <label for="brightnessSlider">Helligkeitstoleranz:</label>
                <input type="range" id="brightnessSlider" min="0" max="100" value="30">
                <div class="range-display">
                    <span>Gering</span>
                    <span>Hoch</span>
                </div>
            </div>
            
            <button id="previewBtn">Vorschau aktualisieren</button>
        </div>

        <div class="preview-section">
            <h3>Vorschau</h3>
            <div class="preview-container">
                <div class="preview-item">
                    <label>Original:</label>
                    <canvas id="originalCanvas"></canvas>
                </div>
                <div class="preview-item">
                    <label>Gefiltert (nur ausgew√§hlte Farben):</label>
                    <canvas id="filteredCanvas"></canvas>
                </div>
            </div>
        </div>

        <div class="generate-section">
            <h3>LUT generieren</h3>
            <p>Wenn die Vorschau Ihren Erwartungen entspricht, k√∂nnen Sie die LUT-Datei generieren und herunterladen.</p>
            <button id="generateBtn">LUT-Datei generieren (.cube)</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageUpload = document.getElementById('imageUpload');
            const colorsContainer = document.getElementById('colorsContainer');
            const addColorBtn = document.getElementById('addColorBtn');
            const brightnessSlider = document.getElementById('brightnessSlider');
            const previewBtn = document.getElementById('previewBtn');
            const generateBtn = document.getElementById('generateBtn');
            const originalCanvas = document.getElementById('originalCanvas');
            const filteredCanvas = document.getElementById('filteredCanvas');
            
            let originalImage = null;
            let colorCounter = 0;
            let eyedropperActive = false;
            let targetColorPicker = null;
            
            // Erste Farbe hinzuf√ºgen
            addColorControl();
            
            // Farb-Control hinzuf√ºgen
            addColorBtn.addEventListener('click', function() {
                addColorControl();
            });
            
            function addColorControl() {
                const colorId = `color-${colorCounter++}`;
                const colorContainer = document.createElement('div');
                colorContainer.className = 'color-container';
                colorContainer.id = `container-${colorId}`;
                
                const colorHeader = document.createElement('div');
                colorHeader.className = 'color-header';
                
                const colorLabel = document.createElement('div');
                colorLabel.innerHTML = `<strong>Farbe ${colorCounter}</strong>`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'button-icon';
                removeBtn.innerHTML = '√ó';
                removeBtn.title = 'Farbe entfernen';
                removeBtn.onclick = function() {
                    colorsContainer.removeChild(colorContainer);
                    if (colorsContainer.children.length === 0) {
                        addColorControl();
                    }
                    updatePreview();
                };
                
                colorHeader.appendChild(colorLabel);
                colorHeader.appendChild(removeBtn);
                
                const colorRow = document.createElement('div');
                colorRow.className = 'color-picker';
                
                const colorPickerContainer = document.createElement('div');
                colorPickerContainer.innerHTML = `
                    <label for="${colorId}">Farbe:</label>
                    <div class="color-controls">
                        <input type="color" id="${colorId}" value="#ff0000">
                        <button class="button-icon eyedropper" data-target="${colorId}" title="Pipette - Farbe aus Bild w√§hlen">üîç</button>
                    </div>
                `;
                
                const colorDisplay = document.createElement('div');
                colorDisplay.id = `display-${colorId}`;
                colorDisplay.className = 'color-display';
                colorDisplay.style.backgroundColor = '#ff0000';
                
                colorRow.appendChild(colorPickerContainer);
                colorRow.appendChild(colorDisplay);
                
                const toleranceContainer = document.createElement('div');
                toleranceContainer.className = 'slider-container';
                toleranceContainer.innerHTML = `
                    <label for="tolerance-${colorId}">Farbtoleranz:</label>
                    <input type="range" id="tolerance-${colorId}" min="0" max="100" value="20">
                    <div class="range-display">
                        <span>Gering</span>
                        <span>Hoch</span>
                    </div>
                `;
                
                colorContainer.appendChild(colorHeader);
                colorContainer.appendChild(colorRow);
                colorContainer.appendChild(toleranceContainer);
                
                colorsContainer.appendChild(colorContainer);
                
                // Event-Listener f√ºr Farbauswahl
                const colorInput = document.getElementById(colorId);
                const colorDisplayEl = document.getElementById(`display-${colorId}`);
                
                colorInput.addEventListener('input', function() {
                    colorDisplayEl.style.backgroundColor = colorInput.value;
                });
                
                // Event-Listener f√ºr Pipette
                const eyedropperBtn = colorContainer.querySelector('.eyedropper');
                eyedropperBtn.addEventListener('click', function() {
                    if (!originalImage) {
                        alert('Bitte laden Sie zuerst ein Bild hoch!');
                        return;
                    }
                    
                    eyedropperActive = true;
                    targetColorPicker = colorId;
                    originalCanvas.classList.add('eyedropper-active');
                });
            }
            
            // Pipetten-Funktionalit√§t
            originalCanvas.addEventListener('click', function(e) {
                if (!eyedropperActive || !originalImage) return;
                
                const rect = originalCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const ctx = originalCanvas.getContext('2d');
                const pixel = ctx.getImageData(x, y, 1, 1).data;
                
                const hexColor = rgbToHex(pixel[0], pixel[1], pixel[2]);
                
                // Setze die ausgew√§hlte Farbe
                const colorInput = document.getElementById(targetColorPicker);
                const colorDisplay = document.getElementById(`display-${targetColorPicker}`);
                
                colorInput.value = hexColor;
                colorDisplay.style.backgroundColor = hexColor;
                
                // Deaktiviere Pipette
                eyedropperActive = false;
                targetColorPicker = null;
                originalCanvas.classList.remove('eyedropper-active');
            });
            
            // Handle image upload
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;
                            drawOriginalImage();
                            updatePreview();
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Draw original image on canvas
            function drawOriginalImage() {
                if (!originalImage) return;
                
                // Set canvas size to match image
                const maxWidth = 450;
                const scale = Math.min(1, maxWidth / originalImage.width);
                originalCanvas.width = originalImage.width * scale;
                originalCanvas.height = originalImage.height * scale;
                filteredCanvas.width = originalImage.width * scale;
                filteredCanvas.height = originalImage.height * scale;
                
                // Draw original image
                const ctxOriginal = originalCanvas.getContext('2d');
                ctxOriginal.drawImage(originalImage, 0, 0, originalCanvas.width, originalCanvas.height);
            }
            
            // Update preview when button is clicked
            previewBtn.addEventListener('click', updatePreview);
            
            // Update preview based on current settings
            function updatePreview() {
                if (!originalImage) return;
                
                const ctxOriginal = originalCanvas.getContext('2d');
                const ctxFiltered = filteredCanvas.getContext('2d');
                
                // Get original image data
                const imageData = ctxOriginal.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
                const data = imageData.data;
                
                // Sammle alle Farbeinstellungen
                const colors = [];
                document.querySelectorAll('.color-container').forEach(container => {
                    const colorId = container.id.replace('container-color-', 'color-');
                    const colorInput = container.querySelector('input[type="color"]');
                    const toleranceInput = container.querySelector('input[type="range"]');
                    
                    colors.push({
                        color: hexToRgb(colorInput.value),
                        tolerance: toleranceInput.value / 100
                    });
                });
                
                const brightnessTolerance = brightnessSlider.value / 100;
                
                // Filter image
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Calculate brightness (0-1)
                    const brightness = (r + g + b) / (3 * 255);
                    
                    let keepPixel = false;
                    
                    // Pr√ºfe, ob die Pixel-Farbe zu einer der ausgew√§hlten Farben passt
                    for (const colorObj of colors) {
                        const targetColor = colorObj.color;
                        const tolerance = colorObj.tolerance;
                        
                        // Calculate color distance (normalized)
                        const colorDistance = calculateColorDistance(r, g, b, targetColor.r, targetColor.g, targetColor.b);
                        
                        const targetBrightness = (targetColor.r + targetColor.g + targetColor.b) / (3 * 255);
                        const brightnessDiff = Math.abs(brightness - targetBrightness);
                        
                        // Check if pixel color is within tolerance
                        if (colorDistance <= tolerance && brightnessDiff <= brightnessTolerance) {
                            keepPixel = true;
                            break;
                        }
                    }
                    
                    if (!keepPixel) {
                        // Make pixel black
                        data[i] = 0;
                        data[i + 1] = 0;
                        data[i + 2] = 0;
                    }
                }
                
                // Draw filtered image
                ctxFiltered.putImageData(imageData, 0, 0);
            }
            
            // Generate and download LUT file
            generateBtn.addEventListener('click', function() {
                if (!originalImage) {
                    alert('Bitte laden Sie zuerst ein Bild hoch!');
                    return;
                }
                
                // Sammle alle Farbeinstellungen
                const colors = [];
                document.querySelectorAll('.color-container').forEach(container => {
                    const colorId = container.id.replace('container-color-', 'color-');
                    const colorInput = container.querySelector('input[type="color"]');
                    const toleranceInput = container.querySelector('input[type="range"]');
                    
                    colors.push({
                        color: hexToRgb(colorInput.value),
                        tolerance: toleranceInput.value / 100
                    });
                });
                
                const brightnessTolerance = brightnessSlider.value / 100;
                
                // Generate LUT data
                let lutData = 'TITLE "Mehrfarben-Filter LUT"\n';
                lutData += 'LUT_3D_SIZE 33\n';
                lutData += 'DOMAIN_MIN 0.0 0.0 0.0\n';
                lutData += 'DOMAIN_MAX 1.0 1.0 1.0\n\n';
                
                // Generate LUT entries (33x33x33 grid)
                const size = 33;
                for (let b = 0; b < size; b++) {
                    for (let g = 0; g < size; g++) {
                        for (let r = 0; r < size; r++) {
                            const rNorm = r / (size - 1);
                            const gNorm = g / (size - 1);
                            const bNorm = b / (size - 1);
                            
                            // Convert normalized color to RGB (0-255)
                            const rValue = rNorm * 255;
                            const gValue = gNorm * 255;
                            const bValue = bNorm * 255;
                            
                            // Calculate brightness
                            const brightness = (rValue + gValue + bValue) / (3 * 255);
                            
                            let keepColor = false;
                            
                            // Check if color matches any of the target colors
                            for (const colorObj of colors) {
                                const targetColor = colorObj.color;
                                const tolerance = colorObj.tolerance;
                                
                                const colorDistance = calculateColorDistance(
                                    rValue, gValue, bValue, 
                                    targetColor.r, targetColor.g, targetColor.b
                                );
                                
                                const targetBrightness = (targetColor.r + targetColor.g + targetColor.b) / (3 * 255);
                                const brightnessDiff = Math.abs(brightness - targetBrightness);
                                
                                if (colorDistance <= tolerance && brightnessDiff <= brightnessTolerance) {
                                    keepColor = true;
                                    break;
                                }
                            }
                            
                            // Determine output color
                            let outR, outG, outB;
                            
                            if (keepColor) {
                                // Keep the color
                                outR = rNorm;
                                outG = gNorm;
                                outB = bNorm;
                            } else {
                                // Make it black
                                outR = outG = outB = 0;
                            }
                            
                            lutData += `${outR.toFixed(6)} ${outG.toFixed(6)} ${outB.toFixed(6)}\n`;
                        }
                    }
                }
                
                // Create and download file
                const blob = new Blob([lutData], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mehrfarben-filter.cube';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
            
            // Helper function: Convert hex color to RGB
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : { r: 0, g: 0, b: 0 };
            }
            
            // Helper function: Convert RGB to hex
            function rgbToHex(r, g, b) {
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }
            
            // Helper function: Calculate normalized color distance
            function calculateColorDistance(r1, g1, b1, r2, g2, b2) {
                // Simple Euclidean distance in RGB space (normalized to 0-1)
                const rDiff = Math.abs(r1 - r2) / 255;
                const gDiff = Math.abs(g1 - g2) / 255;
                const bDiff = Math.abs(b1 - b2) / 255;
                
                return Math.sqrt(rDiff*rDiff + gDiff*gDiff + bDiff*bDiff) / Math.sqrt(3);
            }
        });
    </script>
</body>
</html>
